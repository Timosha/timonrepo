Subject: fix CVE-2014-3616, Reuse cached SSL sessions in unrelated contexts
Origin: http://mailman.nginx.org/pipermail/nginx-devel/2014-September/005948.html
--- a/src/event/ngx_event_openssl.c
+++ b/src/event/ngx_event_openssl.c
@@ -1498,14 +1498,16 @@ ngx_int_t
 ngx_ssl_session_cache(ngx_ssl_t *ssl, ngx_str_t *sess_ctx,
     ssize_t builtin_session_cache, ngx_shm_zone_t *shm_zone, time_t timeout)
 {
-    long  cache_mode;
+    long    cache_mode;
+    u_char  buf[16];
 
     if (builtin_session_cache == NGX_SSL_NO_SCACHE) {
         SSL_CTX_set_session_cache_mode(ssl->ctx, SSL_SESS_CACHE_OFF);
         return NGX_OK;
     }
 
-    SSL_CTX_set_session_id_context(ssl->ctx, sess_ctx->data, sess_ctx->len);
+    RAND_pseudo_bytes(buf, 16);
+    SSL_CTX_set_session_id_context(ssl->ctx, buf, 16);
 
     if (builtin_session_cache == NGX_SSL_NONE_SCACHE) {
 
